@{
	ViewBag.Title = "Slave";
	Layout = null;
}

<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Slave</title>
	@Styles.Render("~/Content/css")
	@Scripts.Render("~/bundles/modernizr")
	<script src="https://kit.fontawesome.com/61a86bc3bd.js" crossorigin="anonymous"></script>
	<style>
		body, html {
			padding: 0;
		}

		#coverarea {
			width: 100%;
			height: 100%;
			top: 0;
			left: 0;
			position: absolute;
			z-index: 2;
		}
	</style>
</head>

<body>
	@if (ViewBag.MasterGuid != null)
	{
		<div id="fullscreen">
			<iframe id="screenshare" ref="screenshare" class="fullScreen2"></iframe>
		</div>
		<div id="coverarea"></div>
		<i class="fas fa-mouse-pointer" id="cursor"></i>
	}
	else
	{
		<h1>No GUID sent</h1>
		<div>Please, check if your provided link is correct!</div>
	}

	@Scripts.Render("~/bundles/jquery")
	@Scripts.Render("~/bundles/bootstrap")
	<script src="~/Scripts/jquery.signalR-2.4.1.js"></script>
	<script src="~/signalr/hubs"></script>
	<script>
		$(function () {
			const urlParams = new URLSearchParams(window.location.search);
			const masterGuid = urlParams.get('masterGuid');

			if (masterGuid != null) {
				createEmptyHtmlTemplateInIframe();

				let screencasting = $.connection.screencastingHub;

				screencasting.client.receiveInitialMasterBody = receiveInitialMasterBody;

				$.connection.hub.qs = 'uuid=' + masterGuid + '&master=false';
				$.connection.hub.logging = true;

				// Size of browser viewport.
				let windowHeight = $(window).height();
				let windowWidth = $(window).width();
				let userAgent = navigator.userAgent;

				$.connection.hub.start().done(function () {
					console.log('---Connected to signalR server via WebSockets');
					screencasting.server.receiveBody(masterGuid);
				});
			}
		});

		function receiveInitialMasterBody(body, head, width, height) {
			let iframe = document.getElementById('screenshare');
			let iframeWindow = iframe.contentWindow;

			$("#screenshare").width(width);
			$("#screenshare").height(height);

			iframeWindow.document.head.innerHTML = head;
			iframeWindow.document.body.innerHTML = body;
			iframeWindow.document.body.innerHTML.replace('</body>', '<style> *{animation-duration: 0s !important} html, body {user-select: none !important; pointer-event: none !important;}</style></body>');
		}

		function createEmptyHtmlTemplateInIframe() {
			let iframeElement = document.getElementsByTagName("iframe")[0];
			iframeElement.id = 'screenshare';
			iframeElement.setAttribute('scrolling', 'no');
			iframeElement.setAttribute('scrolling', 'no');
			iframeElement.setAttribute('frameborder', '0');

			var ifrm = document.getElementById('screenshare');
			ifrm = ifrm.contentWindow || ifrm.contentDocument.document || ifrm.contentDocument;
			ifrm.document.open();
			ifrm.document.write('<!DOCTYPE html>');
			ifrm.document.write('<html>');
			ifrm.document.write('<head></head>');
			ifrm.document.write('<body><div></div></body>');
			ifrm.document.write('</html>');
			ifrm.document.close();
		}
	</script>
</body>
</html>